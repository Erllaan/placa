<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Placas com Filtros Avançados e Exportação PDF</title>

<!-- Choices.js CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />

<style>
  @page {
    size: A4 landscape;
    margin: 10mm 15mm;
  }
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f5f7fa;
    color: #222;
    margin: 20px;
  }
  h1 {
    text-align: center;
    margin-bottom: 20px;
    font-weight: 700;
    color: #2c3e50;
  }
  .filtros {
    max-width: 900px;
    margin: 0 auto 30px auto;
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    align-items: center;
    justify-content: center;
  }
  label {
    font-weight: 600;
    color: #34495e;
  }
  select, input[type="text"] {
    font-size: 16px;
    padding: 8px 12px;
    border: 2px solid #ddd;
    border-radius: 6px;
    min-width: 200px;
    transition: border-color 0.3s ease;
  }
  select:focus, input[type="text"]:focus, .choices__inner {
    border-color: #3498db;
    outline: none;
    box-shadow: 0 0 6px rgba(52, 152, 219, 0.4);
  }
  .choices__inner {
    min-width: 250px;
    border-radius: 6px;
  }
  button {
    background: #3498db;
    color: white;
    border: none;
    padding: 10px 20px;
    font-weight: 600;
    font-size: 16px;
    border-radius: 6px;
    cursor: pointer;
    transition: background-color 0.3s ease;
    user-select: none;
  }
  button:hover {
    background: #2980b9;
  }
  #placas {
    max-width: 900px;
    margin: 0 auto;
  }
  .page {
    width: 297mm;
    height: 210mm;
    background: white;
    box-sizing: border-box;
    border-radius: 8px;
    padding: 2rem;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    page-break-after: always;
    box-shadow: 0 4px 15px rgb(0 0 0 / 0.1);
    text-align: center;
  }
  .rota {
    font-weight: 900;
    font-size: 10vw;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin-bottom: 0.5em;
    max-width: 90%;
    word-wrap: break-word;
    color: #2c3e50;
  }
  .loja {
    font-weight: 800;
    font-size: 8vw;
    max-width: 90%;
    word-wrap: break-word;
    color: #34495e;
  }
  /* Responsive to smaller screens */
  @media(max-width: 1024px) {
    .page {
      width: 100vw;
      height: auto;
      padding: 3rem 1.5rem;
      box-shadow: none;
      page-break-after: auto;
    }
    .rota {
      font-size: 12vw;
    }
    .loja {
      font-size: 9vw;
    }
  }
</style>
</head>
<body>

<h1>Placas - Filtros e Exportação PDF</h1>

<div class="filtros">
  <div>
    <label for="filtroRota">Filtrar por Rota:</label><br />
    <select id="filtroRota" aria-label="Filtro de rota">
      <option value="">Todas as Rotas</option>
    </select>
  </div>

  <div style="min-width: 300px;">
    <label for="filtroLoja">Filtrar por Loja (múltiplas):</label><br />
    <select id="filtroLoja" multiple></select>
  </div>

  <div style="display:flex; align-items:flex-end; gap:10px;">
    <button id="btnLimpar" title="Limpar filtros">Limpar filtros</button>
    <button id="btnExportar" title="Exportar placas filtradas em PDF">Exportar PDF</button>
  </div>
</div>

<div id="placas"></div>

<!-- Bibliotecas Choices.js -->
<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
<!-- jsPDF e html2canvas para exportar PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
(() => {
  const { jsPDF } = window.jspdf;

  const placasData = [
    {rota:"6", codigo:"VD825", nome:"DSP JEQUIE"},
    {rota:"6", codigo:"VD992", nome:"DSP VITORIA DA CONQUISTA"},
    {rota:"6", codigo:"L2437", nome:"DSP VITORIA DA CONQUISTA II"},
    {rota:"6", codigo:"L2527", nome:"DSP VITORIA DA CONQUISTA JURACY"},
    {rota:"6", codigo:"VD863", nome:"DSP BARREIRAS"},
    {rota:"6", codigo:"VD862", nome:"DSP LUIS EDUARDO MAGALHAES"},
    {rota:"6", codigo:"L2554", nome:"DSP ITABUNA III"},
    {rota:"6", codigo:"L2290", nome:"DSP LUIS EDUARDO MAGALHAES II"},
    {rota:"6", codigo:"L2291", nome:"DSP SANTO ANTONIO DE JESUS"},
    {rota:"6", codigo:"L2412", nome:"DSP ILHEUS"},
    {rota:"7", codigo:"L2662", nome:"DSP SHOPPING BOULEVARD"},
    {rota:"7", codigo:"L2127", nome:"DSP FEIRA DE SANTANA IV"},
    {rota:"7", codigo:"VD390", nome:"DSP FEIRA DE SANTANA"},
    {rota:"7", codigo:"L2116", nome:"DSP FEIRA DE SANTANA III"},
    {rota:"7", codigo:"VD630", nome:"DSP DIAS DAVILA"},
    {rota:"7", codigo:"VD552", nome:"DSP CAMACARI"},
    {rota:"7", codigo:"L2531", nome:"DSP GUARAJUBA"},
    {rota:"8", codigo:"L2204", nome:"DSP SHOPPING CENTER LAPA"},
    {rota:"8", codigo:"L2538", nome:"DSP SALVADOR 1"},
    {rota:"8", codigo:"L2052", nome:"DSP METRO SALVADOR"},
    {rota:"8", codigo:"L2283", nome:"DSP SHOPPING VITORIA BOULEVARD"},
    {rota:"8", codigo:"L2161", nome:"DSP CANELA II"},
    {rota:"8", codigo:"VD395", nome:"DSP CANELA"},
    {rota:"8", codigo:"L2064", nome:"DSP SALVADOR CHAME CHAME"},
    {rota:"9", codigo:"L2173", nome:"DSP PARQUE SHOPPING BAHIA"},
    {rota:"9", codigo:"L2119", nome:"DSP ESTRADA DO COCO"},
    {rota:"9", codigo:"L2363", nome:"DSP VILAS DO ATLANTICO I"},
    {rota:"9", codigo:"L2668", nome:"DSP ALPHAVILLE LITORAL NORTE"},
    {rota:"9", codigo:"VD547", nome:"DSP ITAPUA"},
    {rota:"9", codigo:"VD458", nome:"DSP ITAPUA II"},
    {rota:"9", codigo:"VD744", nome:"DSP PIATA"},
    {rota:"9", codigo:"VD737", nome:"DSP PATAMARES"},
    {rota:"9", codigo:"VD546", nome:"DSP JORGE AMADO"},
    {rota:"10", codigo:"L2003", nome:"DSP TROBOGY"},
    {rota:"10", codigo:"VD834", nome:"DSP SAO RAFAEL"},
    {rota:"10", codigo:"L2174", nome:"DSP SHOPPING PARALELA"},
    {rota:"10", codigo:"VD845", nome:"DSP CAJAZEIRAS"},
    {rota:"10", codigo:"L2221", nome:"DSP PERIPERI"},
    {rota:"10", codigo:"VD643", nome:"DSP SIMOES FILHO"},
    {rota:"10", codigo:"VD620", nome:"DSP CANDEIAS"},
    {rota:"11", codigo:"L2077", nome:"DSP SHOPPING BELLA VISTA"},
    {rota:"11", codigo:"L2211", nome:"DSP PERNAMBUES"},
    {rota:"11", codigo:"VD544", nome:"DSP MATATU"},
    {rota:"11", codigo:"VD929", nome:"DSP ACUPE DE BROTAS"},
    {rota:"11", codigo:"L2631", nome:"DSP BROTAS III"},
    {rota:"11", codigo:"VD399", nome:"DSP NOVA BROTAS"},
    {rota:"11", codigo:"VD981", nome:"DSP VASCO DA GAMA"},
    {rota:"11", codigo:"L2277", nome:"DSP FEDERACAO SALVADOR"},
    {rota:"11", codigo:"VD397", nome:"DSP ONDINA"},
    {rota:"12", codigo:"L2243", nome:"DSP SHOPPING BARRA SALVADOR"},
    {rota:"12", codigo:"L2088", nome:"DSP RIO VERMELHO II"},
    {rota:"12", codigo:"VD432", nome:"DSP PITUBA III"},
    {rota:"12", codigo:"L2056", nome:"DSP PITUBA IV"},
    {rota:"12", codigo:"VD890", nome:"DSP CAMINHO DAS ARVORES II"},
    {rota:"12", codigo:"VD712", nome:"DSP ANITA GARIBALDI"},
    {rota:"12", codigo:"VD398", nome:"DSP MIGUEL CALMON"},
    {rota:"12", codigo:"L2191", nome:"DSP MARES"},
    {rota:"13", codigo:"VD697", nome:"DSP IMBUI"},
    {rota:"13", codigo:"VD550", nome:"DSP COSTA AZUL"},
    {rota:"13", codigo:"L2123", nome:"DSP COSTA AZUL II"},
    {rota:"13", codigo:"VD936", nome:"DSP STIEP"},
    {rota:"13", codigo:"VD393", nome:"DSP CABULA"},
    {rota:"13", codigo:"VD821", nome:"DSP SALVADOR III"},
    {rota:"14", codigo:"VD530", nome:"DSP LAURO DE FREITAS"},
    {rota:"14", codigo:"VD558", nome:"DSP STELLA MARIS"},
    {rota:"15", codigo:"VD926", nome:"DSP CABULA II"},
    {rota:"15", codigo:"L2169", nome:"DSP CANDEAL"},
    {rota:"15", codigo:"L2093", nome:"DSP SHOPPING DA BAHIA 3 PISO"},
    {rota:"15", codigo:"L2092", nome:"DSP SHOPPING DA BAHIA 2 PISO"},
    {rota:"15", codigo:"L2091", nome:"DSP SHOPPING DA BAHIA 1 PISO"},
    {rota:"16", codigo:"VD713", nome:"DSP LARGO DO TAMARINEIRO"},
    {rota:"16", codigo:"VD970", nome:"DSP CAMINHO DE AREIA"},
    {rota:"16", codigo:"VD604", nome:"DSP GRACA"},
    {rota:"16", codigo:"VD220", nome:"DSP PITUBA"},
    {rota:"16", codigo:"VD434", nome:"DSP ALTO DO ITAIGARA"},
    {rota:"16", codigo:"VD568", nome:"DSP CAMINHO DAS ARVORES"},
    {rota:"20", codigo:"VD913", nome:"DSP CAMINHO DAS ARVORES III"},
    {rota:"20", codigo:"VD435", nome:"DSP SHOPPING SALVADOR"},
    {rota:"20", codigo:"L2280", nome:"DSP ALPHAVILLE SALVADOR 1"},
    {rota:"1", codigo:"L2507", nome:"DSP SHOPPING PATTEO OLINDA"},
    {rota:"1", codigo:"L2526", nome:"DSP SHOPPING CARUARU"},
    {rota:"1", codigo:"L2438", nome:"DSP CARUARU II"},
    {rota:"1", codigo:"L2384", nome:"DSP VITORIA DE SANTO ANTAO"},
    {rota:"1", codigo:"VD794", nome:"DSP JANGA"},
    {rota:"1", codigo:"VD871", nome:"DSP OLINDA II"},
    {rota:"2", codigo:"VD698", nome:"DSP OLINDA"},
    {rota:"2", codigo:"L2493", nome:"DSP ESPINHEIRO"},
    {rota:"2", codigo:"VD288", nome:"DSP RECIFE CENTRO II"},
    {rota:"2", codigo:"L2589", nome:"DSP IPUTINGA"},
    {rota:"2", codigo:"L2368", nome:"DSP CAXANGA"},
    {rota:"2", codigo:"L2386", nome:"DSP IMBIRIBEIRA"},
    {rota:"2", codigo:"L2421", nome:"DSP IPSEP"},
    {rota:"3", codigo:"VD772", nome:"DSP BOA VIAGEM"},
    {rota:"3", codigo:"L2617", nome:"DPSP CONSELHEIRO AGUIAR III"},
    {rota:"3", codigo:"VD755", nome:"DSP BOA VIAGEM II"},
    {rota:"3", codigo:"L2534", nome:"DSP DOMINGOS FERREIRA"},
    {rota:"3", codigo:"L2453", nome:"DSP RIBEIRO DE BRITO"},
    {rota:"3", codigo:"VD770", nome:"DSP BOA VIAGEM V"},
    {rota:"3", codigo:"L2597", nome:"DSP SETUBAL"},
    {rota:"3", codigo:"VD767", nome:"DSP GUARARAPES III"},
    {rota:"4", codigo:"L2371", nome:"DSP ROSA E SILVA"},
    {rota:"4", codigo:"L2375", nome:"DSP ESTRADA DO ARRAIAL"},
    {rota:"4", codigo:"VD695", nome:"DSP TORRE"},
    {rota:"4", codigo:"L2383", nome:"DSP MADALENA II"},
    {rota:"4", codigo:"L2074", nome:"DSP SHOPPING RIOMAR"},
    {rota:"4", codigo:"VD690", nome:"DSP BOA VIAGEM IV"},
    {rota:"4", codigo:"L2508", nome:"DSP SHOPPING RECIFE"},
    {rota:"5", codigo:"L2428", nome:"DSP PETROLINA"},
    {rota:"5", codigo:"L2429", nome:"DSP PETROLINA CENTRO"},
    {rota:"5", codigo:"L2496", nome:"DSP PETROLINA II"},
    {rota:"5", codigo:"L2582", nome:"DSP SHOPPING RIVER"},
  ];

  // DOM elements
  const selectRota = document.getElementById("filtroRota");
  const selectLoja = document.getElementById("filtroLoja");
  const placasDiv = document.getElementById("placas");
  const btnLimpar = document.getElementById("btnLimpar");
  const btnExportar = document.getElementById("btnExportar");

  // Initialize Choices.js on loja multi-select
  const choicesLoja = new Choices(selectLoja, {
    removeItemButton: true,
    searchPlaceholderValue: "Digite para buscar lojas...",
    noResultsText: "Nenhuma loja encontrada",
    itemSelectText: "Clique para selecionar",
    placeholder: true,
    placeholderValue: "Selecione ou digite lojas...",
    searchResultLimit: 50,
    shouldSort: true,
  });

  // Populate rotas dropdown
  function popularRotas() {
    const rotas = [...new Set(placasData.map(p => p.rota))].sort((a,b) => Number(a)-Number(b));
    rotas.forEach(r => {
      const option = document.createElement("option");
      option.value = r;
      option.textContent = "ROTA " + r;
      selectRota.appendChild(option);
    });
  }

  // Populate lojas in Choices.js (unique sorted by nome)
  function popularLojas() {
    const lojasUnicas = [...new Map(placasData.map(p => [p.nome, p])).values()];
    // Ordenar por nome da loja
    lojasUnicas.sort((a,b) => a.nome.localeCompare(b.nome));
    // Adicionar opções ao select
    lojasUnicas.forEach(loja => {
      choicesLoja.setChoices(
        [{value: loja.nome, label: `${loja.codigo} – ${loja.nome}`, selected: false}], 
        'value', 'label', false
      );
    });
  }

  // Criar placa HTML
  function criarPlaca(p) {
    const div = document.createElement("div");
    div.className = "page";
    div.innerHTML = `<div class="rota">ROTA ${p.rota}</div><div class="loja">${p.codigo} - ${p.nome}</div>`;
    return div;
  }

  // Renderizar placas filtradas
  function renderizarPlacas() {
    placasDiv.innerHTML = "";

    const rotaSelecionada = selectRota.value;
    const lojasSelecionadas = choicesLoja.getValue(true); // array de nomes selecionados

    const placasFiltradas = placasData.filter(p => {
      const rotaOK = !rotaSelecionada || p.rota === rotaSelecionada;
      const lojaOK = lojasSelecionadas.length === 0 || lojasSelecionadas.includes(p.nome);
      return rotaOK && lojaOK;
    });

    if(placasFiltradas.length === 0) {
      placasDiv.innerHTML = `<p style="text-align:center; font-weight:600; color:#777;">Nenhuma placa encontrada para os filtros selecionados.</p>`;
      return;
    }

    placasFiltradas.forEach(p => {
      placasDiv.appendChild(criarPlaca(p));
    });
  }

  // Limpar filtros
  btnLimpar.addEventListener("click", () => {
    selectRota.value = "";
    choicesLoja.clearStore();
    renderizarPlacas();
  });

  // Exportar para PDF
  btnExportar.addEventListener("click", async () => {
    const placasFiltradas = placasDiv.querySelectorAll(".page");
    if(placasFiltradas.length === 0) {
      alert("Nenhuma placa para exportar!");
      return;
    }
    
    const pdf = new jsPDF({
      orientation: "landscape",
      unit: "mm",
      format: "a4",
    });

    for(let i = 0; i < placasFiltradas.length; i++) {
      const placa = placasFiltradas[i];
      // Usar html2canvas para capturar a placa como imagem
      const canvas = await html2canvas(placa, {scale: 2});
      const imgData = canvas.toDataURL("image/png");

      const imgProps = pdf.getImageProperties(imgData);
      const pdfWidth = pdf.internal.pageSize.getWidth();
      const pdfHeight = pdf.internal.pageSize.getHeight();

      // Ajustar imagem para preencher a página mantendo proporção
      let width, height;
      if(imgProps.width > imgProps.height) {
        width = pdfWidth;
        height = (imgProps.height * pdfWidth) / imgProps.width;
      } else {
        height = pdfHeight;
        width = (imgProps.width * pdfHeight) / imgProps.height;
      }

      if(i > 0) pdf.addPage();
      pdf.addImage(imgData, 'PNG', (pdfWidth - width) / 2, (pdfHeight - height) / 2, width, height);
    }

    pdf.save("placas_filtradas.pdf");
  });

  // Eventos filtros
  selectRota.addEventListener("change", renderizarPlacas);
  selectLoja.addEventListener("change", renderizarPlacas);

  // Inicialização
  popularRotas();
  popularLojas();
  renderizarPlacas();

})();
</script>

</body>
</html>
